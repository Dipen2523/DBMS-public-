# Common Table Expression (CTE) in MySQL

A Common Table Expression (CTE) is a temporary named result set that allows you to write complex queries in a more readable and maintainable manner. In MySQL, CTEs are defined using the `WITH` keyword, followed by the name of the CTE and the SELECT statement that defines it. Here's an overview of CTEs in MySQL along with examples:

## MySQL CTE Syntax

The basic syntax for creating a Common Table Expression (CTE) in MySQL is as follows:

```sql
WITH cte_name AS (
    SELECT column1, column2, ...
    FROM table_name
    WHERE condition
)
SELECT *
FROM cte_name;
```

You can define multiple CTEs within the same query by separating each CTE definition with a comma.

## MySQL CTE Examples

### Example 1: Total Revenue Calculation

Suppose you have a sales table with columns "product_name", "sales_date", and "revenue". You want to calculate the total revenue for each product over the past 30 days, as well as the percentage change in revenue compared to the previous 30-day period.

```sql
WITH sales_last_30_days AS (
    SELECT product_name, SUM(revenue) AS total_revenue
    FROM sales
    WHERE sales_date BETWEEN '2023-03-10' AND '2023-04-09'
    GROUP BY product_name
),
sales_previous_30_days AS (
    SELECT product_name, SUM(revenue) AS total_revenue
    FROM sales
    WHERE sales_date BETWEEN '2023-02-08' AND '2023-03-09'
    GROUP BY product_name
)
SELECT
    s.product_name,
    s.total_revenue,
    (s.total_revenue - p.total_revenue) / p.total_revenue * 100 AS revenue_change
FROM sales_last_30_days s
JOIN sales_previous_30_days p ON s.product_name = p.product_name;
```

### Example 2: Monthly Sales Report

Suppose you have a sales table with columns "order_date", "product", "quantity", and "revenue". You want to create a report that shows the total revenue generated by each product, broken down by month, along with the percentage of total revenue generated by each product.

```sql
WITH monthly_sales AS (
  SELECT
    DATE_FORMAT(order_date, '%Y-%m') AS month,
    product,
    SUM(revenue) AS revenue
  FROM sales
  GROUP BY month, product
),
total_sales AS (
  SELECT
    month,
    SUM(revenue) AS total_revenue
  FROM monthly_sales
  GROUP BY month
)
SELECT
  monthly_sales.month,
  monthly_sales.product,
  monthly_sales.revenue,
  (monthly_sales.revenue / total_sales.total_revenue) * 100 AS percentage
FROM
  monthly_sales
JOIN total_sales ON monthly_sales.month = total_sales.month
ORDER BY monthly_sales.month, percentage DESC;
```

## Benefits of Using CTE

- Simplify complex queries
- Improve query performance
- Reuse code
- Traverse hierarchical data
- Simplify debugging
- Improve code readability

CTEs are a powerful tool in MySQL for writing complex queries in a more efficient and maintainable way.